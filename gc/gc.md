# **GC**
Golang的GC经过长时间的发展，已经从最初的秒级别减少到微妙级别，其核心实现是三色标记法和混合写屏障

## 三色标记法
核心是使用三种颜色来表示内存状态：
* 白色：未访问
* 黑色：已完成扫描
* 灰色：代扫描

写屏障：用来保证黑色对象不直接指向白色对象（维护不变式）

流程：
1. 开启写屏障，并扫描栈，全局变量和寄存器（STW）
2. 并发扫描
3. 关闭写屏障，准备清扫（STW)
4. 清扫内存

触发时机：
1. 超出堆内存阈值
2. 定时触发
3. 手动触发

如何调优：
1. 相关参数：
```
GOGO = 100 (default) // off 关闭GC， 调大这个值会减少GC频率
debug.SetGCPercent(200) // 设置内存增长比例达到一个阈值后触发GC
GOMEMLIMIT=1Gib // 设置存在达到这个阈值后触发GC

# GC 追踪
GODEBUG=gctrace=1 ./app

# 输出格式：
# gc 1 @0.012s 2%: 0.026+1.0+0.019 ms clock, 0.21+0.98/1.8/0.26+0.15 ms cpu, 4->4->1 MB, 5 MB goal, 8 P
#    │  │     │    │                        │                              │          │      │
#    │  │     │    │                        │                              │          │      └─ P 数量
#    │  │     │    │                        │                              │          └─ 目标堆大小
#    │  │     │    │                        │                              └─ 堆变化
#    │  │     │    │                        └─ CPU 时间分解
#    │  │     │    └─ 墙钟时间（STW + 并发 + STW）
#    │  │     └─ GC 占用时间百分比
#    │  └─ 程序启动后时间
#    └─ GC 次数

# 更详细的调度追踪
GODEBUG=schedtrace=1000 ./app
```

2. 调优流程
```
┌─────────────────────────────────────────────────────────────────┐
│                       GC 调优流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 开启 gctrace=1 观察 GC 行为                                 │
│     └─ 关注：频率、暂停时间、堆大小                              │
│                                                                 │
│  2. 使用 pprof 分析内存分配热点                                 │
│     └─ go tool pprof http://localhost:6060/debug/pprof/heap    │
│                                                                 │
│  3. 优化代码减少分配                                            │
│     └─ 对象复用、预分配、避免逃逸                                │
│                                                                 │
│  4. 根据场景调整 GOGC 和 GOMEMLIMIT                             │
│     └─ 低延迟：默认或更低 GOGC                                  │
│     └─ 高吞吐：更高 GOGC + GOMEMLIMIT                           │
│                                                                 │
│  5. 持续监控                                                    │
│     └─ 生产环境监控 GC 指标                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```