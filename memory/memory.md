# **Memory allocator**
The memory allocator of Golang is based on the Google's TCMalloc design, optimised for multi-core and high-concurrency scenarios.

## core design philosophy

|design | purpose |
|------|-----|
|multi-level cache|reduce lock contention|
|size classification| reduce memory fragmentation|
|batch operation|amortize allocation cost|
|thread-local cache|lock-free fast path|

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Go 内存分配器                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         mheap (全局堆)                               │   │
│  │                         全局唯一，需加锁                              │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    mcentral (中心缓存)                       │   │   │
│  │  │               每个 size class 一个，需加锁                    │   │   │
│  │  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐      ┌──────┐         │   │   │
│  │  │  │ 8B   │ │ 16B  │ │ 24B  │ │ 32B  │ ···  │ 32KB │         │   │   │
│  │  │  │class │ │class │ │class │ │class │      │class │         │   │   │
│  │  │  └──────┘ └──────┘ └──────┘ └──────┘      └──────┘         │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    ▲                                        │
│                                    │ 批量获取/归还 mspan                     │
│                                    ▼                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   mcache     │  │   mcache     │  │   mcache     │  │   mcache     │    │
│  │   (P0)       │  │   (P1)       │  │   (P2)       │  │   (P3)       │    │
│  │   无锁访问   │  │   无锁访问   │  │   无锁访问   │  │   无锁访问   │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
│         ▲                 ▲                 ▲                 ▲             │
│         │                 │                 │                 │             │
│     Goroutine         Goroutine         Goroutine         Goroutine        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 分配决策流程

```
                            ┌─────────────────┐
                            │  分配请求 size  │
                            └────────┬────────┘
                                     │
                                     ▼
                          ┌─────────────────────┐
                          │   size <= 16B ?     │
                          │   且 noscan ?       │
                          └──────────┬──────────┘
                                     │
                     ┌───────────────┴───────────────┐
                     │ 是                            │ 否
                     ▼                               ▼
            ┌─────────────────┐            ┌─────────────────┐
            │  微对象分配      │            │  size <= 32KB ? │
            │  Tiny Allocator │            └────────┬────────┘
            │                 │                     │
            │  多个对象共用    │         ┌──────────┴──────────┐
            │  一个 16B 槽位   │         │ 是                  │ 否
            └─────────────────┘         ▼                     ▼
                                ┌─────────────────┐  ┌─────────────────┐
                                │   小对象分配    │  │   大对象分配    │
                                │  mcache → span  │  │   直接 mheap    │
                                └─────────────────┘  └─────────────────┘
```

## 小对象分配详细流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           小对象分配 (size <= 32KB)                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  1. 计算 size class            │
                    │     size → sizeclass (0-67)   │
                    │     + noscan → spanclass      │
                    └───────────────┬────────────────┘
                                    │
                                    ▼
                    ┌────────────────────────────────┐
                    │  2. 获取当前 P 的 mcache       │
                    │     c := getg().m.p.mcache    │
                    └───────────────┬────────────────┘
                                    │
                                    ▼
                    ┌────────────────────────────────┐
                    │  3. 从 mcache 获取对应 span    │
                    │     span := c.alloc[spanclass]│
                    └───────────────┬────────────────┘
                                    │
                                    ▼
                         ┌─────────────────────┐
                         │  span 有空闲槽位？  │
                         └──────────┬──────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │ 有                            │ 无
                    ▼                               ▼
        ┌───────────────────────┐      ┌───────────────────────┐
        │  4a. 快速分配         │      │  4b. mcache.refill()  │
        │  addr = nextFreeIndex │      │  从 mcentral 获取新的  │
        │  无锁！O(1)           │      │  span，需加锁          │
        └───────────┬───────────┘      └───────────┬───────────┘
                    │                              │
                    └──────────────┬───────────────┘
                                   │
                                   ▼
                    ┌────────────────────────────────┐
                    │  5. 返回对象地址               │
                    │     addr = span.base + idx*size│
                    └────────────────────────────────┘
```

## mcache 结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              mcache (每个 P 一个)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────── tiny allocator ───────────────┐                          │
│  │  tiny:       0xc000100000  (当前块地址)       │                          │
│  │  tinyoffset: 8             (下一个可用偏移)   │                          │
│  │  tinyAllocs: 156           (已分配计数)       │                          │
│  └──────────────────────────────────────────────┘                          │
│                                                                             │
│  ┌─────────────── alloc [136]*mspan ────────────┐                          │
│  │                                              │                          │
│  │  [0]  → span (8B,  scan)    ──→ ┌────────┐  │                          │
│  │  [1]  → span (8B,  noscan)  ──→ │ mspan  │  │                          │
│  │  [2]  → span (16B, scan)    ──→ │        │  │                          │
│  │  [3]  → span (16B, noscan)  ──→ │ 包含   │  │                          │
│  │  [4]  → span (24B, scan)    ──→ │ 多个   │  │                          │
│  │  [5]  → span (24B, noscan)  ──→ │ object │  │                          │
│  │  ...                            │ 槽位   │  │                          │
│  │  [134] → span (32KB, scan)      └────────┘  │                          │
│  │  [135] → span (32KB, noscan)                │                          │
│  │                                              │                          │
│  └──────────────────────────────────────────────┘                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## mspan 结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              mspan (内存跨度)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  元数据：                                                                    │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │  startAddr:  0xc000100000      (起始地址)                          │    │
│  │  npages:     1                 (占用页数)                          │    │
│  │  elemsize:   16                (每个 object 大小)                  │    │
│  │  nelems:     512               (object 总数: 8KB/16B)              │    │
│  │  freeindex:  3                 (下一个空闲索引)                    │    │
│  │  spanclass:  3                 (size class + noscan)               │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  位图：                                                                      │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │  allocBits:  [1,1,1,0,0,0,0,0,...]  (分配位图)                     │    │
│  │  gcmarkBits: [1,1,0,0,0,0,0,0,...]  (GC 标记位图)                  │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  内存布局：                                                                  │
│  ┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────────┐     │
│  │ obj0 │ obj1 │ obj2 │ obj3 │ obj4 │ obj5 │ obj6 │ ...  │  obj511  │     │
│  │ 已用 │ 已用 │ 已用 │ 空闲 │ 空闲 │ 空闲 │ 空闲 │      │   空闲   │     │
│  │ 16B  │ 16B  │ 16B  │ 16B  │ 16B  │ 16B  │ 16B  │      │   16B    │     │
│  └──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────────┘     │
│     ↑                    ↑                                                  │
│  startAddr          freeindex=3                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 分配与回收完整流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              完整生命周期                                    │
└─────────────────────────────────────────────────────────────────────────────┘

【分配方向】                                          【回收方向】
     │                                                      ▲
     ▼                                                      │
┌─────────┐                                           ┌─────────┐
│   OS    │ ◄─────── mmap/munmap ──────────────────► │   OS    │
└────┬────┘                                           └────▲────┘
     │                                                      │
     ▼                                                      │
┌─────────────────────────────────────────────────────────────────────────────┐
│                              mheap                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  pages (页分配器)                                                      │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │ │
│  │  │  基数树 + 摘要 → O(1) 查找连续空闲页                             │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  mcentral[0..135]                                                      │ │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐                         │ │
│  │  │  partial   │ │  partial   │ │  partial   │  有空闲的 span           │ │
│  │  ├────────────┤ ├────────────┤ ├────────────┤                         │ │
│  │  │   full     │ │   full     │ │   full     │  无空闲的 span           │ │
│  │  └────────────┘ └────────────┘ └────────────┘                         │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              ▼                      ▼                      ▼
       ┌────────────┐         ┌────────────┐         ┌────────────┐
       │  mcache P0 │         │  mcache P1 │         │  mcache P2 │
       │            │         │            │         │            │
       │ alloc[136] │         │ alloc[136] │         │ alloc[136] │
       │  ├─ span   │         │  ├─ span   │         │  ├─ span   │
       │  ├─ span   │         │  ├─ span   │         │  ├─ span   │
       │  └─ ...    │         │  └─ ...    │         │  └─ ...    │
       └──────┬─────┘         └──────┬─────┘         └──────┬─────┘
              │                      │                      │
              ▼                      ▼                      ▼
         Goroutines              Goroutines             Goroutines
```

## Size Class 表（部分）

| Class | 对象大小 | span 页数 | 对象个数 | 浪费率 |
|-------|---------|----------|---------|--------|
| 1 | 8B | 1 | 1024 | 12.5% |
| 2 | 16B | 1 | 512 | 6.25% |
| 3 | 24B | 1 | 341 | 4.17% |
| 4 | 32B | 1 | 256 | 3.13% |
| 5 | 48B | 1 | 170 | 2.08% |
| 6 | 64B | 1 | 128 | 1.56% |
| ... | ... | ... | ... | ... |
| 67 | 32KB | 4 | 1 | ~0% |

> × 2 (scan/noscan) = 136 种 spanClass

## 一图总结

```
                              分配请求
                                 │
                 ┌───────────────┼───────────────┐
                 ▼               ▼               ▼
            ┌────────┐      ┌────────┐      ┌────────┐
            │ <16B   │      │ ≤32KB  │      │ >32KB  │
            │ noscan │      │        │      │        │
            └───┬────┘      └───┬────┘      └───┬────┘
                │               │               │
                ▼               ▼               ▼
           ┌─────────┐     ┌─────────┐     ┌─────────┐
           │  tiny   │     │ mcache  │     │  mheap  │
           │allocator│     │(无锁)   │     │(加锁)   │
           └─────────┘     └────┬────┘     └─────────┘
                                │
                         span 用完？
                         ┌──────┴──────┐
                         │ 否          │ 是
                         ▼             ▼
                    ┌─────────┐   ┌─────────┐
                    │ 返回    │   │mcentral │
                    │ 地址    │   │(加锁)   │
                    └─────────┘   └────┬────┘
                                       │
                                span 用完？
                                ┌──────┴──────┐
                                │ 否          │ 是
                                ▼             ▼
                           ┌─────────┐   ┌─────────┐
                           │ 返回    │   │ mheap   │
                           │ span    │   │ 分配新页│
                           └─────────┘   └─────────┘
```

## 页分配器（Go 1.14+）

使用**基数树 + 位图 + 摘要**实现 O(1) 页查找：

```
                    Level 0 (根)
                   ┌──────────┐
                   │ summary  │  覆盖整个堆
                   └────┬─────┘
                        │
         ┌──────────────┼──────────────┐
         ▼              ▼              ▼
    Level 1         Level 1        Level 1
  ┌────────┐      ┌────────┐     ┌────────┐
  │summary │      │summary │     │summary │
  └───┬────┘      └───┬────┘     └───┬────┘
      │               │               │
     ...             ...             ...
      │               │               │
      ▼               ▼               ▼
   ┌────┐          ┌────┐          ┌────┐
   │bits│          │bits│          │bits│  底层位图
   └────┘          └────┘          └────┘
```

**摘要 (pallocSum)** 编码三个值到一个 uint64：
- `start`: 从左边开始的连续空闲页数
- `max`: 区域内最大连续空闲页数
- `end`: 从右边开始的连续空闲页数

通过 `max` 可以 **O(1) 判断**该区域能否满足 n 页的需求。

## scan vs noscan

| 类型 | 含义 | GC 需要扫描内部 |
|------|------|----------------|
| scan | 对象内部有指针 | ✅ 需要 |
| noscan | 对象内部无指针 | ❌ 跳过 |

分离存储的好处：GC 可以**整个跳过 noscan span**，减少扫描开销。

## 微对象分配 (Tiny Allocator)

条件：`size < 16B && noscan`

```
tiny 块 (16B)：
┌────┬────┬──────────┬──────┬──────┐
│ 1B │ 3B │   4B     │  2B  │ 6B空 │
│int8│填充│  int32   │int16 │      │
└────┴────┴──────────┴──────┴──────┘
  0    1     4          8     10   16
```

- 多个微对象共用一个 16B 槽位
- 使用 `tinyoffset` 追踪下一个可用位置
- 不区分内部边界，整个块作为一个整体管理

# **Go 逃逸分析原理**
逃逸分析是编译器在编译期判断变量应该分配到堆上还是栈上的技术，核心决策方法是：变量的生命周期是否小于函数的生命周期，小于就分配栈上，否则分配到堆上

## 典型场景
* 返回局部变量的指针
* 分配一个大的数据，导致栈空间不足
* 向chan存入指针对象
* 闭包变量
* 动态分发对象
* 切片和map存储指针

## 查看逃逸分析的结果
* go build -gcflags="-m" main.go
* go build -gcflags="-m -m" main.go
* go build -gcflags="-m" ./...


